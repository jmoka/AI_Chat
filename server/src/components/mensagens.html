<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Embutido</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #chat-container, #file-list-container, #upload-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 100%;
            max-width: 600px;
            margin: 10px;
        }

        #chat {
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        #inputArea {
            display: flex;
            margin-top: 10px;
        }

        #message {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 14px;
            outline: none;
        }

        #sendButton {
            padding: 12px 24px;
            background-color: #0084ff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #sendButton:hover {
            background-color: #0073e6;
        }

        #sendButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #fileList {
            list-style: none;
            padding: 0;
            border: 1px solid white;
            border-radius: 5px;
            background-color: rgb(164, 172, 16);
            color: white;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #fileList li {
            
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
          
        }

        #fileList li span {
            flex: 1;
            font-weight: bold;
            color: black;
        }

        #fileList li button {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: auto; /* Ajusta o tamanho do botão ao conteúdo */
            text-align: center; /* Centraliza o texto no botão */
            padding: 5px; /* Adiciona um pequeno espaçamento interno */
            font-size: 14px; /* Ajusta o tamanho da fonte */
            
        }

        #fileList li button:hover {
            background-color: #e60000;
        }

        @media (max-width: 768px) {
            #fileList li {
                width: 100%; /* Em telas menores, ocupa 100% da largura */
            }
        }

        .message-container {
            display: flex;
            width: 100%;
            margin: 5px 0;
        }

        .user-message-container {
            justify-content: flex-end; /* Alinha mensagens do usuário à direita */
        }

        .assistant-message-container {
            justify-content: flex-start; /* Alinha mensagens do assistente à esquerda */
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            color: white; /* Cor do texto padrão */
        }

        .user-message {
            background-color: #0084ff; /* Fundo azul */
            color: white; /* Letras brancas */
            border-radius: 15px 15px 5px 15px; /* Bordas arredondadas */
        }

        .assistant-message {
            background-color: #28a745; /* Fundo verde */
            color: white; /* Letras brancas */
            border-radius: 15px 15px 15px 5px; /* Bordas arredondadas */
        }

        .timestamp {
            font-size: 11px;
            color: #8e8e8e;
            margin-top: 4px;
            text-align: right;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px;">
        <!-- Chat Container -->
        <div id="chat-container">
            <div id="chat"></div>
            <div id="inputArea">
                <textarea id="message" placeholder="Digite uma mensagem..." 
                          onkeypress="handleKeyPress(event)" 
                          rows="4" 
                          style="resize: none;"></textarea>
                <button id="sendButton" onclick="sendMessage()">Enviar</button>
            </div>
        </div>

        <!-- File List Container -->
        <div id="file-list-container">
            <h3 style="text-align: center;">Arquivos Salvos</h3>
            <button id="refreshButton" style="display: block; margin: 10px auto; padding: 10px 20px; background-color: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Atualizar Lista
            </button>
            <ul id="fileList">
            </ul>
        </div>

        <!-- Upload Container -->
        <div id="upload-container">
            <h3 style="text-align: center;">Enviar Arquivo</h3>
            <form id="uploadForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; align-items: center;">
                <input type="file" id="fileInput" name="file" style="margin-bottom: 10px; padding: 5px;" />
                <button type="submit" id="uploadButton" style="padding: 10px 20px; background-color: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Enviar Arquivo
                </button>
            </form>
            <div id="uploadStatus" style="margin-top: 10px; font-size: 14px; color: #555; text-align: center;"></div>
        </div>

        <!-- Botão para processar arquivos -->
        <div id="process-container" style="margin-top: 20px; max-width: 600px; margin: 0 auto;">
            <h3 style="text-align: center;">Processar Arquivos</h3>
            <button id="processButton" style="display: block; margin: 10px auto; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Processar Arquivos
            </button>
            <button id="refreshProcessedButton" style="display: block; margin: 10px auto; padding: 10px 20px; background-color: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Atualizar Lista de Processados
            </button>
            <button id="loadProcessedButton" style="display: block; margin: 10px auto; padding: 10px 20px; background-color: #ffc107; color: black; border: none; border-radius: 5px; cursor: pointer;">
                Carregar Arquivos Processados
            </button>
            <ul id="processedFileList" style="list-style: none; padding: 0; border: 1px solid white; border-radius: 5px; background-color: black; color: white; padding: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
            </ul>
        </div>

        <!-- Botão para salvar logs -->
        <div id="log-container" style="margin-top: 20px; max-width: 600px; margin: 0 auto;">
            <h3 style="text-align: center;">Salvar Logs</h3>
            <button id="saveLogButton" style="display: block; margin: 10px auto; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Salvar Logs
            </button>
            <button id="refreshLogButton" style="display: block; margin: 10px auto; padding: 10px 20px; background-color: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Atualizar Lista de Logs
            </button>
            <ul id="logFileList" style="list-style: none; padding: 0; border: 1px solid white; border-radius: 5px; background-color: black; color: white; padding: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
            </ul>
        </div>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const sendButton = document.getElementById('sendButton');
        const messageInput = document.getElementById('message');
        const saveLogButton = document.getElementById('saveLogButton');
        const refreshLogButton = document.getElementById('refreshLogButton');
        const logFileList = document.getElementById('logFileList');

        // Array para armazenar as mensagens trocadas
        const messageLog = [];

        function getTimestamp() {
            return new Date().toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function appendMessage(message, isUser = true, isError = false) {
            const containerDiv = document.createElement('div');
            containerDiv.className = `message-container ${isUser ? 'user-message-container' : 'assistant-message-container'}`;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'} ${isError ? 'error-message' : ''}`;
            messageDiv.textContent = message;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'timestamp';
            timeDiv.textContent = getTimestamp();

            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = isUser ? 'row-reverse' : 'row';
            wrapper.style.alignItems = 'center';
            wrapper.style.gap = '10px';

            wrapper.appendChild(messageDiv);
            wrapper.appendChild(timeDiv);
            containerDiv.appendChild(wrapper);

            chat.appendChild(containerDiv);
            chat.scrollTop = chat.scrollHeight;

            // Salva a mensagem no array de log
            messageLog.push({ message, isUser, timestamp: getTimestamp() });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function setLoading(isLoading) {
            sendButton.disabled = isLoading;
            messageInput.disabled = isLoading;
            sendButton.textContent = isLoading ? 'Enviando...' : 'Enviar';
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            setLoading(true);
            messageInput.value = "";

            try {
                appendMessage(message);

                const response = await fetch('http://localhost:3000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor');
                }

                const data = await response.json();
                appendMessage(data.response, false);
            } catch (error) {
                console.error('Erro:', error);
                appendMessage('Desculpe, ocorreu um erro ao processar sua mensagem. Por favor, tente novamente.', false, true);
            } finally {
                setLoading(false);
            }
        }

        const fileList = document.getElementById('fileList');
        const refreshButton = document.getElementById('refreshButton');

        async function loadFileList() {
            try {
                const response = await fetch('http://localhost:3000/files');
                if (!response.ok) {
                    throw new Error('Erro ao carregar a lista de arquivos.');
                }

                const files = await response.json();
                fileList.innerHTML = '';

                if (files.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.textContent = 'Nenhum arquivo salvo.';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#888';
                    fileList.appendChild(emptyMessage);
                    return;
                }

                files.forEach((file) => {
                    const listItem = document.createElement('li');
                    listItem.style.marginBottom = '10px';
                    listItem.style.display = 'flex';
                    listItem.style.justifyContent = 'space-between';
                    listItem.style.alignItems = 'center';
                    listItem.style.padding = '10px';
                    listItem.style.border = '1px solid #ddd';
                    listItem.style.borderRadius = '5px';
                    listItem.style.backgroundColor = '#fff';

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.style.paddingInlineEnd= '5px';
                    fileNameSpan.textContent = file;
                    fileNameSpan.style.flex = '1';
                    fileNameSpan.style.color = 'black'; // Define a cor do texto como preto
                    fileNameSpan.style.fontWeight = 'bold'; // Opcional: deixa o texto em negrito

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Deletar';
                    deleteButton.style.padding = '5px 10px';
                    deleteButton.style.backgroundColor = '#ff4d4d';
                    deleteButton.style.color = 'white';
                    deleteButton.style.border = 'none';
                    deleteButton.style.borderRadius = '5px';
                    deleteButton.style.cursor = 'pointer';
                    deleteButton.onclick = async () => {
                        await deleteFile(file);
                    };

                    listItem.appendChild(fileNameSpan);
                    listItem.appendChild(deleteButton);
                    fileList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Erro ao carregar a lista de arquivos:', error);
            }
        }

        async function deleteFile(fileName) {
            try {
                const response = await fetch(`http://localhost:3000/files/${fileName}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error('Erro ao deletar o arquivo.');
                }

                alert(`Arquivo "${fileName}" deletado com sucesso.`);
                loadFileList();
            } catch (error) {
                console.error('Erro ao deletar o arquivo:', error);
            }
        }

        refreshButton.addEventListener('click', loadFileList);
        loadFileList();

        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('uploadStatus');

        // Função para lidar com o envio de arquivos
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Evita o comportamento padrão do formulário

            const file = fileInput.files[0];
            if (!file) {
                uploadStatus.textContent = 'Por favor, selecione um arquivo.';
                uploadStatus.style.color = 'red';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            uploadButton.disabled = true;
            uploadStatus.textContent = 'Enviando arquivo...';
            uploadStatus.style.color = '#555';

            try {
                const response = await fetch('http://localhost:3000/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error('Erro ao enviar o arquivo.');
                }

                const data = await response.json();
                uploadStatus.textContent = `Arquivo "${data.fileName}" enviado com sucesso.`;
                uploadStatus.style.color = 'green';

                // Atualiza a lista de arquivos após o upload
                loadFileList();
            } catch (error) {
                console.error('Erro ao enviar o arquivo:', error);
                uploadStatus.textContent = 'Erro ao enviar o arquivo.';
                uploadStatus.style.color = 'red';
            } finally {
                uploadButton.disabled = false;
            }
        });

        const processButton = document.getElementById('processButton');
        const refreshProcessedButton = document.getElementById('refreshProcessedButton');
        const processedFileList = document.getElementById('processedFileList');
        const loadProcessedButton = document.getElementById('loadProcessedButton');

        // Função para carregar arquivos processados e alimentar a memória
        loadProcessedButton.addEventListener('click', async () => {
            try {
                const response = await fetch('http://localhost:3000/load-processed', {
                    method: 'POST',
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar arquivos processados.');
                }

                const data = await response.json();
                alert(data.message);
            } catch (error) {
                console.error('Erro ao carregar arquivos processados:', error.message);
                alert('Erro ao carregar arquivos processados.');
            }
        });

        // Função para processar arquivos
        processButton.addEventListener('click', async () => {
            try {
                // Faz a requisição para o endpoint de processamento
                const response = await fetch('http://localhost:3000/process-files', {
                    method: 'POST',
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro desconhecido ao processar os arquivos.');
                }

                const processedFiles = await response.json();
                processedFileList.innerHTML = ''; // Limpa a lista antes de exibir os arquivos processados

                if (processedFiles.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.textContent = 'Nenhum arquivo processado.';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#888';
                    processedFileList.appendChild(emptyMessage);
                    return;
                }

                // Exibe os arquivos processados
                processedFiles.forEach((file) => {
                    const listItem = document.createElement('li');
                    listItem.style.marginBottom = '10px';
                    listItem.style.display = 'flex';
                    listItem.style.justifyContent = 'space-between';
                    listItem.style.alignItems = 'center';
                    listItem.style.padding = '10px';
                    listItem.style.border = '1px solid #ddd';
                    listItem.style.borderRadius = '5px';
                    listItem.style.backgroundColor = '#fff';

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.textContent = file;
                    fileNameSpan.style.flex = '1';
                    fileNameSpan.style.color = 'black';
                    fileNameSpan.style.fontWeight = 'bold';

                    listItem.appendChild(fileNameSpan);
                    processedFileList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Erro ao processar os arquivos:', error.message);
                alert(`Erro ao processar os arquivos: ${error.message}`);
            }
        });

        // Função para carregar a lista de arquivos processados
        async function loadProcessedFileList() {
            try {
                const response = await fetch('http://localhost:3000/processed-files');
                if (!response.ok) {
                    throw new Error('Erro ao carregar a lista de arquivos processados.');
                }

                const files = await response.json();
                processedFileList.innerHTML = ''; // Limpa a lista antes de exibir os arquivos

                if (files.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.textContent = 'Nenhum arquivo processado.';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#888';
                    processedFileList.appendChild(emptyMessage);
                    return;
                }

                files.forEach((file) => {
                    const listItem = document.createElement('li');
                    listItem.style.marginBottom = '10px';
                    listItem.style.display = 'flex';
                    listItem.style.justifyContent = 'space-between';
                    listItem.style.alignItems = 'center';
                    listItem.style.padding = '10px';
                    listItem.style.border = '1px solid #ddd';
                    listItem.style.borderRadius = '5px';
                    listItem.style.backgroundColor = '#fff';

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.textContent = file;
                    fileNameSpan.style.flex = '1';
                    fileNameSpan.style.color = 'black';
                    fileNameSpan.style.fontWeight = 'bold';

                    listItem.appendChild(fileNameSpan);
                    processedFileList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Erro ao carregar a lista de arquivos processados:', error);
            }
        }

        // Adiciona o evento ao botão de atualizar a lista de processados
        refreshProcessedButton.addEventListener('click', loadProcessedFileList);

        // Carrega a lista de arquivos processados ao iniciar
        loadProcessedFileList();

        // Função para salvar as mensagens no servidor
        saveLogButton.addEventListener('click', async () => {
            try {
                const response = await fetch('http://localhost:3000/save-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ messages: messageLog }),
                });

                if (!response.ok) {
                    throw new Error('Erro ao salvar as mensagens.');
                }

                const data = await response.json();
                alert(data.message);
            } catch (error) {
                console.error('Erro ao salvar as mensagens:', error.message);
                alert('Erro ao salvar as mensagens.');
            }
        });

        // Função para carregar o conteúdo de um arquivo de log
        async function loadLogFileContent(fileName) {
            try {
                const response = await fetch(`http://localhost:3000/logs/${fileName}`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar o conteúdo do log.');
                }

                const messages = await response.json();

                // Limpa o chat atual
                chat.innerHTML = '';

                // Adiciona as mensagens do log ao chat
                messages.forEach((msg) => {
                    appendMessage(msg.message, msg.isUser);
                });

                alert(`Mensagens do log "${fileName}" carregadas no chat.`);
            } catch (error) {
                console.error('Erro ao carregar o conteúdo do log:', error.message);
                alert('Erro ao carregar o conteúdo do log.');
            }
        }

        // Função para carregar a lista de logs
        async function loadLogFileList() {
            try {
                const response = await fetch('http://localhost:3000/logs');
                if (!response.ok) {
                    throw new Error('Erro ao carregar a lista de logs.');
                }

                const files = await response.json();
                logFileList.innerHTML = ''; // Limpa a lista antes de exibir os arquivos

                if (files.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.textContent = 'Nenhum log salvo.';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#888';
                    logFileList.appendChild(emptyMessage);
                    return;
                }

                files.forEach((file) => {
                    const listItem = document.createElement('li');
                    listItem.style.marginBottom = '10px';
                    listItem.style.display = 'flex';
                    listItem.style.justifyContent = 'space-between';
                    listItem.style.alignItems = 'center';
                    listItem.style.padding = '10px';
                    listItem.style.border = '1px solid #ddd';
                    listItem.style.borderRadius = '5px';
                    listItem.style.backgroundColor = '#fff';
                    listItem.style.cursor = 'pointer';

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.textContent = file;
                    fileNameSpan.style.flex = '1';
                    fileNameSpan.style.color = 'black';
                    fileNameSpan.style.fontWeight = 'bold';

                    // Adiciona evento de clique para carregar o conteúdo do log
                    listItem.addEventListener('click', () => loadLogFileContent(file));

                    listItem.appendChild(fileNameSpan);
                    logFileList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Erro ao carregar a lista de logs:', error.message);
            }
        }

        // Adiciona o evento ao botão de atualizar a lista de logs
        refreshLogButton.addEventListener('click', loadLogFileList);

        // Carrega a lista de logs ao iniciar
        loadLogFileList();

        // Salvar mensagens automaticamente ao sair ou recarregar a página
        window.addEventListener('beforeunload', async (event) => {
            if (messageLog.length > 0) {
                try {
                    await fetch('http://localhost:3000/save-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ messages: messageLog }),
                    });
                    console.log('Mensagens salvas automaticamente.');
                } catch (error) {
                    console.error('Erro ao salvar mensagens automaticamente:', error.message);
                }
            }
        });
    </script>
</body>
</html>